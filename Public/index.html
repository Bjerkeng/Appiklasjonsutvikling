<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8" />
  <title>TodoList </title>
</head>

<body>
    
    <h1> TodoList JSTL</h1>
    
    <div id="container"></div>

<!------------------------- Logg inn temp ------------------------------->
    
    <template id="authenticateUserUITemplate">
        <form>
            <label for="userName">User name:</label>
            <input type="text" id="userName">

            <label for="password">Password:</label>
            <input type="password" id="password">

            <label for="rememberMe">Remember Me:</label>
            <input type="checkbox" id="rememberMe">

            <button  id="loginBtn"  >Login</button>
            <button id="createUserBt" onclick="createUserBtn()" type="button">Create User</button>
        </form>
    </template>
    
<!------------------------- Lag bruker temp ------------------------------->

    <template id="createUserUITemplate">
        <form id="createUserForm">
            <label for="fullName">Full name:</label>
            <input type="text" id="fullName">
            
            <label for="userName">User name:</label>
            <input type="text" id="userName">

            <label for="email">E-mail:</label>
            <input type="email" id="email">

            <label for="password">Password:</label>
            <input type="password" id="password">

            <input type="submit" value="Create" />
        </form>
    </template>
    
<!------------------------- Velkommen temp ------------------------------->
    
    <template id="todoListTemplate">
        <h1>Hei og velkommen</h1>
        <p>Velkommen</p>
        
    </template>
    
</body>
    
<script>
        const DEBUG = true;
        var authenticationToken = null;
        var authenticatedUser = null;
    
        let cont = document.getElementById("container");
        
        (function() {
            if (!authenticatedUser) {
                displayLoginForm();
                console.log("ikke logget inn")
            } else {
                displayTodoListTemplate();
            }
        })();
    
        function viewTemp(id, cont){
            cont.innerHTML = "";
            let temp = document.getElementById(id);
            let clone = temp.content.cloneNode(true);
            cont.appendChild(clone);
        }
    
/*---------------------------- Logg inn ----------------------------------*/
    
        function displayLoginForm(){
            viewTemp("authenticateUserUITemplate", cont);
            let bt = document.getElementById("loginBtn");
            bt.onclick = loginBtn;
            
            //let loginBt = document.querySelector("#loginBt");
            //let createBt = document.querySelector("#createUserBt");
        }
    
        function loginBtn(evt){
            evt.preventDefault();
            console.log("Login bt clicked");
            let userName = document.getElementById("userName").value;
            let password = document.getElementById("password").value;
            if (userName.length > 1 && password.length > 1) {
                /// login loginlogin
                
                let request={
                    method:"POST",
                    body:JSON.stringify({
                        userName:userName,
                        password:password
                    }),
                    headers: {
                    "Content-Type": "application/json; charset=utf-8"
                }
                }
                
                fetch(`/app/login`,request).then(data => {
                    if (data.status === 200) {
                        return data.json()
                    } else {
                        return new PromiseRejectionEvent();
                    }
                }).then(json => {
                    // User is logged in.
                    authenticatedUser = json;
                    displayTodoListTemplate();
                    console.log(json);
                    // Velkommen skjerm
                }).catch(err => {
                    // deal with error
                })
            } else {
                alert("Danger! Danger!")
            }                
        }
    
/*---------------------------- Lag bruker ----------------------------------*/
          
        function createUserBtn(){
            displayCreateUserForm();
            console.log("Create user bt clicked");
        }
        
        function displayCreateUserForm(){
            
              
            viewTemp("createUserUITemplate", cont);
            let form = document.getElementById("createUserForm");
            //document.body.appendChild(form);
            
            form.onsubmit = function(evt){
                
                evt.preventDefault();
                let fullName = document.getElementById("fullName").value;
                let userName = document.getElementById("userName").value;
                let email = document.getElementById("email").value;
                let password = document.getElementById("password").value;
                
                fetch('/app/createUser',{
                    method: "POST",
                    body: JSON.stringify({
                        fullName: fullName,
                        userName: userName,
                        email: email,
                        password: password
                    }),
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },
                    
                }).then(function(data){
                    if(data.status < 400){
                        return data.json();
                    }
                }).then(function(createdUser){
                    console.log(createdUser);    
                    displayLoginForm();
                    
                }).catch(err =>{
                    console.error(err);
            });
            
            }
        }   
    
/*---------------------------- Velkommen ----------------------------------*/
    
        function displayTodoListTemplate(){
            viewTemp("todoListTemplate", cont);
            console.log("velkommen");
        }
    
   </script>



</html>